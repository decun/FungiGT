<%- include('partials/header') %>

<head>
    <!-- SweetAlert2 para modales de ayuda -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
    <main class="flex-grow p-6">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Panel lateral: Explorador de archivos -->
                <div class="w-full md:w-1/3 lg:w-1/4">
                    <%- include('partials/file-explorer') %>
                </div>
                
                <!-- Panel principal -->
                <div class="w-full md:w-2/3 lg:w-3/4">
                    <h2 class="text-3xl font-bold mb-8 flex items-center text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Analizador Funcional de Genomas
                    </h2>

                    <!-- Selector para elegir entre eggNOG, BlastN y Bindash -->
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
                            </svg>
                            Seleccionar Herramienta de Análisis
                        </h3>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-3">
                                Elige la herramienta que deseas utilizar:
                            </label>
                            <select id="toolSelector" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="">Seleccione una herramienta</option>
                                <option value="eggnog">eggNOG-mapper - Anotación Funcional</option>
                                <option value="blastn">BlastN - Búsqueda de Homología</option>
                                <option value="bindash">BinDash - Comparación de Genomas y Cálculo de ANI</option>
                            </select>
                        </div>
                    </div>

                    <!-- Configuración de eggNOG-mapper -->
                    <div id="eggNOGConfig" class="bg-white p-8 rounded-xl shadow-lg mb-8 border border-gray-200" style="display: none;">
                        <div class="border-l-4 border-green-500 pl-6 mb-6">
                            <h3 class="text-2xl font-semibold mb-2 flex items-center text-gray-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V3m0 0a9 9 0 919 9h-3m0 0a9 9 0 01-9 9v-3m0 0a9 9 0 919-9z" />
                                </svg>
                                Configuración de eggNOG-mapper
                            </h3>
                            <p class="text-gray-600 text-sm">Herramienta para anotación funcional de proteínas y genes</p>
                            
                            <!-- Información sobre bases de datos -->
                            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    ℹ️ Información sobre Base de Datos
                                </h4>
                                <p class="text-blue-700 text-sm">
                                    eggNOG-mapper utiliza <strong>una sola base de datos principal</strong> (~50 GB) que contiene información de múltiples dominios taxonómicos. 
                                    El <strong>alcance taxonómico</strong> determina qué nivel de la jerarquía usar para la anotación:
                                </p>
                                <ul class="text-blue-700 text-sm mt-2 ml-4 list-disc">
                                    <li><strong>🍄 Fungi (4751)</strong>: Específico para hongos</li>
                                    <li><strong>🌿 Eukaryota (2759)</strong>: Recomendado para hongos (más cobertura)</li>
                                    <li><strong>🌍 Cellular organisms (1)</strong>: Máxima cobertura taxonómica</li>
                                </ul>
                            </div>
                        </div>
                        
                        <form id="eggNOGForm" class="space-y-6">
                            <!-- Configuración Principal -->
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Datos de Entrada</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                                            Ruta al Archivo de Entrada (-i)
                                            <div class="relative ml-2 group">
                                                <svg xmlns="http://www.w3.org/2000/svg" id="helpProteinPath" class="h-4 w-4 text-gray-400 cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            </div>
                                            <button type="button" id="listFilesBtn" class="ml-2 px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                                Ver archivos disponibles
                                            </button>
                                        </label>
                                        <input type="text" id="proteinFilePath" name="proteinFilePath" placeholder="/data/genomes/mi_archivo.faa" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <p class="mt-1 text-xs text-gray-500">Ruta absoluta al archivo FASTA de proteínas</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Nombre de Salida (-o)
                                            <div class="relative ml-2 inline-block group">
                                                <svg xmlns="http://www.w3.org/2000/svg" id="helpOutputName" class="h-4 w-4 text-gray-400 cursor-help inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            </div>
                                        </label>
                                        <input type="text" id="outputName" name="outputName" placeholder="resultado_eggnog" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <p class="mt-1 text-xs text-gray-500">Nombre base para los archivos de salida (sin extensión)</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Configuración Básica -->
                            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Configuración Básica</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                                            Alcance Taxonómico (--tax_scope)
                                            <div class="relative ml-2 group">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                                    <div class="text-center">
                                                        <div class="font-semibold mb-1">Determina el nivel taxonómico para la anotación</div>
                                                        <div class="mt-1 text-yellow-300">🍄 Para hongos: usa 4751 (Fungi) o 2759 (Eukaryota)</div>
                                                    </div>
                                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                                </div>
                                            </div>
                                        </label>
                                        <select id="taxScopeSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors mb-2">
                                            <option value="2759">🌿 Eukaryota (2759) - Recomendado para hongos</option>
                                            <option value="4751">🍄 Fungi (4751) - Específico para hongos</option>
                                            <option value="1">🌍 Cellular organisms (1) - Todos los organismos</option>
                                            <option value="2">🦠 Bacteria (2) - Solo bacterias</option>
                                            <option value="2157">⚡ Archaea (2157) - Solo arqueas</option>
                                            <option value="custom">✏️ Personalizado</option>
                                        </select>
                                        <input type="text" id="taxScope" name="taxScope" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                               value="2759" required style="display: none;" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Número de CPUs (--cpu)
                                        </label>
                                        <input type="number" id="cpu" name="cpu" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                               min="1" value="1" required />
                                    </div>
                                </div>
                            </div>

                            <!-- Opciones Avanzadas -->
                            <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                                <div class="flex items-center mb-4">
                                    <input type="checkbox" id="toggleAdvancedEggNOG" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                    <label for="toggleAdvancedEggNOG" class="ml-3 text-lg font-semibold text-gray-800">Mostrar Opciones Avanzadas</label>
                                </div>
                                
                                <div id="advancedEggNOGOptions" class="space-y-4" style="display: none;">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Tipo de Datos (--itype)
                                            </label>
                                            <select id="itype" name="itype" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors">
                                                <option value="proteins">Proteínas</option>
                                                <option value="CDS">CDS</option>
                                                <option value="genome">Genoma</option>
                                                <option value="metagenome">Metagenoma</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Predicción de Genes (--genepred)
                                            </label>
                                            <select id="genepred" name="genepred" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors">
                                                <option value="search">Search</option>
                                                <option value="prodigal">Prodigal</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                            <input type="checkbox" id="translate" name="translate" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                            <label for="translate" class="ml-3 text-sm text-gray-700 font-medium">Traducir CDS (--translate)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Opciones de Búsqueda -->
                            <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Opciones de Búsqueda</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Modo de Búsqueda (-m)
                                        </label>
                                        <select id="mode" name="mode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors">
                                            <option value="diamond">Diamond</option>
                                            <option value="mmseqs">MMseqs2</option>
                                            <option value="hmmer">HMMER</option>
                                            <option value="no_search">No Search</option>
                                            <option value="cache">Cache</option>
                                            <option value="novel_fams">Novel Families</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            E-value (--evalue)
                                        </label>
                                        <input type="number" step="any" id="evalue" name="evalue" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" 
                                               value="0.001" required />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Porcentaje de Identidad (--pident)
                                        </label>
                                        <input type="number" step="any" id="pident" name="pident" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" 
                                               min="0" max="100" />
                                    </div>
                                </div>
                            </div>

                            <!-- Opciones de Salida y Ejecución -->
                            <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Opciones de Salida y Ejecución</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                        <input type="checkbox" id="noFileComments" name="noFileComments" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                        <label for="noFileComments" class="ml-3 text-sm text-gray-700 font-medium">Sin comentarios (--no_file_comments)</label>
                                    </div>
                                    <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                        <input type="checkbox" id="resume" name="resume" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                        <label for="resume" class="ml-3 text-sm text-gray-700 font-medium">Reanudar (--resume)</label>
                                    </div>
                                    <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                        <input type="checkbox" id="override" name="override" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                        <label for="override" class="ml-3 text-sm text-gray-700 font-medium">Sobrescribir (--override)</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Botones de Acción -->
                                                        <!-- Verificación de Base de Datos -->
                            <div id="databaseStatus" class="mb-6 p-6 bg-blue-50 border-2 border-blue-300 rounded-lg shadow-md">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <h5 class="font-bold text-blue-800 text-lg flex items-center mb-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                                            </svg>
                                            Base de Datos eggNOG
                                        </h5>
                                        <p id="dbStatusText" class="text-blue-700 font-medium">Verificando disponibilidad...</p>
                                    </div>
                                    <button type="button" id="checkDbBtn" 
                                        class="px-5 py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white rounded-lg font-bold transition-all duration-200 flex items-center shadow-lg hover:shadow-xl transform hover:scale-105">
                                        <svg xmlns="http://www.w3Estado de .org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        🔍 VERIFICAR ESTADO
                                    </button>
                                </div>
                            </div>

                            <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                                <button type="button" id="showEggNOGCommandBtn"
                                        class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5-6h3" />
                                    </svg>
                                    Mostrar Comando
                                </button>
                                <button type="submit" id="runEggNOGBtn"
                                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m-9-4V8a2 2 0 012-2h8a2 2 0 012 2v2M7 16h10" />
                                    </svg>
                                    Ejecutar eggNOG-mapper
                                </button>
                            </div>
                            
                            <div id="eggNOGCommandDisplay" class="mt-4 p-4 bg-gray-100 rounded-lg hidden">
                                <h5 class="font-semibold text-gray-800 mb-2">Comando eggNOG:</h5>
                                <pre id="eggNOGCommand" class="text-sm text-gray-800 whitespace-pre-wrap bg-white p-3 rounded border"></pre>
                            </div>
                        </form>
                    </div>

                    <!-- Configuración de BlastN -->
                    <div id="blastnConfig" class="bg-white p-8 rounded-xl shadow-lg mb-8 border border-gray-200" style="display: none;">
                        <div class="border-l-4 border-purple-500 pl-6 mb-6">
                            <h3 class="text-2xl font-semibold mb-2 flex items-center text-gray-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Configuración de BlastN
                            </h3>
                            <p class="text-gray-600 text-sm">Herramienta para búsqueda de homología de secuencias nucleotídicas</p>
                        </div>
                        
                        <form id="blastnForm" class="space-y-6">
                            <!-- Configuración Principal -->
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Archivos de Entrada y Salida</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                                            Archivo de Entrada (-query)
                                            <div class="relative ml-2 group">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                                    <div class="text-center">
                                                        <div class="font-semibold mb-1">Archivo FASTA con secuencias query</div>
                                                        <div class="mt-1 text-yellow-300">Ejemplo: E:/blastN/input/tu_archivo.fasta</div>
                                                    </div>
                                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                                </div>
                                            </div>
                                        </label>
                                        <input type="text" id="queryFilePath" name="queryFilePath" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" 
                                               placeholder="E:/blastN/input/tu_archivo.fasta" required />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Archivo de Salida (-out)
                                        </label>
                                        <input type="text" id="out_blastn" name="out_blastn" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" 
                                               placeholder="E:/blastN/output/resultados.txt" required />
                                    </div>
                                </div>
                            </div>

                            <!-- Configuración de Base de Datos -->
                            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Configuración de Base de Datos</h4>
                                <div class="grid grid-cols-1 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Tipo de Base de Datos
                                        </label>
                                        <select id="databaseType" name="databaseType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors mb-3">
                                            <option value="predefined">Base de Datos Predefinida</option>
                                            <option value="custom">Base de Datos Personalizada</option>
                                        </select>
                                        
                                        <select id="predefinedDatabase" name="database" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                            <option value="nt">NT (Nucleotide)</option>
                                            <option value="nr">NR (Non-redundant)</option>
                                            <option value="swissprot">SwissProt</option>
                                        </select>

                                        <input type="text" id="customDatabase" name="customDatabase" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                               placeholder="E:/blastn/output/tu_base_datos" style="display: none;" />
                                    </div>
                                </div>
                            </div>

                            <!-- Parámetros de Búsqueda -->
                            <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Parámetros de Búsqueda</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            E-value (-evalue)
                                        </label>
                                        <input type="number" step="any" id="evalue_blastn" name="evalue_blastn" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" 
                                               value="0.001" required />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Tamaño de palabra (-word_size)
                                        </label>
                                        <input type="number" id="wordSize" name="wordSize" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" 
                                               min="4" value="11" required />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Número de hilos (-num_threads)
                                        </label>
                                        <input type="number" id="numThreads" name="numThreads" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" 
                                               min="1" value="1" required />
                                    </div>
                                </div>
                            </div>

                            <!-- Opciones de Salida -->
                            <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Opciones de Salida</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Formato de salida (-outfmt)
                                        </label>
                                        <select id="outfmt" name="outfmt" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" required>
                                            <option value="0">0 (Pairwise)</option>
                                            <option value="6">6 (Tabular)</option>
                                            <option value="7">7 (Tabular with comments)</option>
                                            <option value="8">8 (XML2 ASN.1)</option>
                                            <option value="10">10 (CSV)</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                        <input type="checkbox" id="remote_blastn" name="remote_blastn" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                        <label for="remote_blastn" class="ml-3 text-sm text-gray-700 font-medium">Usar BLAST remoto (-remote)</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Botones de Acción -->
                            <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                                <button type="button" id="showBlastNCommandBtn" 
                                        class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5-6h3" />
                                    </svg>
                                    Mostrar Comando
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                    Ejecutar BlastN
                                </button>
                            </div>
                            
                            <div id="blastnCommandDisplay" class="mt-4 p-4 bg-gray-100 rounded-lg hidden">
                                <h5 class="font-semibold text-gray-800 mb-2">Comando BlastN:</h5>
                                <pre id="blastnCommand" class="text-sm text-gray-800 whitespace-pre-wrap bg-white p-3 rounded border"></pre>
                            </div>
                        </form>
                    </div>

                    <!-- Configuración de BinDash -->
                    <div id="bindashConfig" class="bg-white p-8 rounded-xl shadow-lg mb-8 border border-gray-200" style="display: none;">
                        <div class="border-l-4 border-orange-500 pl-6 mb-6">
                            <h3 class="text-2xl font-semibold mb-2 flex items-center text-gray-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                Configuración de BinDash
                            </h3>
                            <p class="text-gray-600 text-sm">Herramienta ultrarrápida para comparación de genomas y cálculo de ANI (Average Nucleotide Identity)</p>
                        </div>

                        <!-- Información sobre BinDash -->
                        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-6 rounded-lg border border-orange-200 mb-6">
                            <h4 class="text-lg font-semibold mb-3 text-gray-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ¿Qué es BinDash?
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
                                <div>
                                    <p class="mb-2"><strong>• Comparación ultrarrápida:</strong> Compara genomas completos en segundos</p>
                                    <p class="mb-2"><strong>• Cálculo de ANI:</strong> Estima Average Nucleotide Identity con alta precisión</p>
                                    <p class="mb-2"><strong>• Eficiente en memoria:</strong> Maneja terabytes de datos en laptops típicas</p>
                                </div>
                                <div>
                                    <p class="mb-2"><strong>• Formatos soportados:</strong> FASTA, FASTQ (comprimidos o no)</p>
                                    <p class="mb-2"><strong>• Algoritmo avanzado:</strong> Binwise Densified MinHash</p>
                                    <p class="mb-2"><strong>• Casos de uso:</strong> Genomas, metagenomas, pangenomas</p>
                                </div>
                            </div>
                        </div>
                        
                        <form id="bindashForm" class="space-y-6">
                            <!-- Selector de Modo de Operación -->
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Modo de Operación</h4>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Seleccionar operación a realizar:
                                    </label>
                                    <select id="bindashMode" name="bindashMode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors" required>
                                        <option value="">Seleccione una operación</option>
                                        <option value="sketch">Sketch - Crear firmas genómicas</option>
                                        <option value="dist">Dist - Calcular distancias entre genomas</option>
                                        <option value="complete">Completo - Sketch + Dist en un solo paso</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Configuración para Sketch -->
                            <div id="sketchConfig" class="bg-blue-50 p-6 rounded-lg border border-blue-200" style="display: none;">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Configuración de Sketch</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                                            Archivo/Lista de Genomas
                                            <div class="relative ml-2 group">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                                    <div class="text-center">
                                                        <div class="font-semibold mb-1">Archivo FASTA individual o lista de archivos</div>
                                                        <div class="mt-1 text-yellow-300">Ejemplo: genome.fasta o genomes_list.txt</div>
                                                    </div>
                                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                                </div>
                                            </div>
                                        </label>
                                        <input type="text" id="sketchInput" name="sketchInput" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                               placeholder="./data/genome.fasta" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Archivo de Salida (--outfname)
                                        </label>
                                        <input type="text" id="sketchOutput" name="sketchOutput" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                                               placeholder="genome.sketch" />
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="useListFile" name="useListFile" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <label for="useListFile" class="ml-3 text-sm text-gray-700 font-medium">Usar archivo de lista (--listfname)</label>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Marcar si el archivo de entrada es una lista de genomas (uno por línea)</p>
                                </div>
                            </div>

                            <!-- Configuración para Dist -->
                            <div id="distConfig" class="bg-green-50 p-6 rounded-lg border border-green-200" style="display: none;">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Configuración de Distancias</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Sketch de Consulta
                                        </label>
                                        <input type="text" id="querySketch" name="querySketch" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors" 
                                               placeholder="query.sketch" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Sketch de Referencia (opcional)
                                        </label>
                                        <input type="text" id="targetSketch" name="targetSketch" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors" 
                                               placeholder="reference.sketch (opcional para all-vs-all)" />
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Archivo de Salida (--outfname)
                                    </label>
                                    <input type="text" id="distOutput" name="distOutput" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors" 
                                           placeholder="distances.txt" />
                                </div>
                            </div>

                            <!-- Configuración Completa -->
                            <div id="completeConfig" class="bg-purple-50 p-6 rounded-lg border border-purple-200" style="display: none;">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800">Configuración Completa (Sketch + Dist)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Directorio de Genomas
                                        </label>
                                        <input type="text" id="genomesDir" name="genomesDir" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" 
                                               placeholder="./data/genomes/" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Patrón de Archivos
                                        </label>
                                        <input type="text" id="filePattern" name="filePattern" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" 
                                               value="*.fasta" />
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Prefijo de Salida
                                    </label>
                                    <input type="text" id="outputPrefix" name="outputPrefix" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" 
                                           placeholder="analysis_result" />
                                </div>
                            </div>

                            <!-- Parámetros Avanzados -->
                            <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                                <div class="flex items-center mb-4">
                                    <input type="checkbox" id="toggleAdvancedBindash" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                    <label for="toggleAdvancedBindash" class="ml-3 text-lg font-semibold text-gray-800">Mostrar Parámetros Avanzados</label>
                                </div>
                                
                                <div id="advancedBindashOptions" class="space-y-4" style="display: none;">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Tamaño de k-mer (--kmersize)
                                            </label>
                                            <input type="number" id="kmerSize" name="kmerSize" 
                                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" 
                                                   min="1" max="32" value="16" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Tamaño de Sketch (--sketchsize64)
                                            </label>
                                            <input type="number" id="sketchSize" name="sketchSize" 
                                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" 
                                                   min="188" value="256" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Bits por Hash (--bbits)
                                            </label>
                                            <input type="number" id="bbits" name="bbits" 
                                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors" 
                                                   min="1" max="8" value="1" />
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Estrategia de Densificación (--dens)
                                            </label>
                                            <select id="densification" name="densification" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors">
                                                <option value="1">1 - Optimal Densification (Shrivastava 2017)</option>
                                                <option value="2">2 - Faster Densification (Mai et al. 2020)</option>
                                                <option value="3">3 - Re-randomized Densification (Li et al. 2019)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Modelo Evolutivo (--model)
                                            </label>
                                            <select id="evolutionModel" name="evolutionModel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors">
                                                <option value="poisson">Poisson (por defecto)</option>
                                                <option value="binomial">Binomial</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                            <input type="checkbox" id="canonical" name="canonical" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                            <label for="canonical" class="ml-3 text-sm text-gray-700 font-medium">Usar k-mers canónicos (--canonical)</label>
                                        </div>
                                        <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                            <input type="checkbox" id="protein" name="protein" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                            <label for="protein" class="ml-3 text-sm text-gray-700 font-medium">Modo proteína (--protein)</label>
                                        </div>
                                        <div class="flex items-center p-3 bg-white rounded-lg border border-gray-200">
                                            <input type="checkbox" id="verbose" name="verbose" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                            <label for="verbose" class="ml-3 text-sm text-gray-700 font-medium">Modo verbose (--verbose)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Información sobre Interpretación de Resultados -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                                <h4 class="text-lg font-semibold mb-3 text-gray-800 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Interpretación de Resultados
                                </h4>
                                <div class="text-sm text-gray-700 space-y-2">
                                    <p><strong>Formato de salida:</strong> Cada línea contiene 5 campos separados por tabulaciones:</p>
                                    <ul class="list-disc list-inside ml-4 space-y-1">
                                        <li><strong>Genoma consulta (Q):</strong> Nombre del genoma de consulta</li>
                                        <li><strong>Genoma objetivo (T):</strong> Nombre del genoma objetivo</li>
                                        <li><strong>Distancia de mutación:</strong> Entre Q y T (1-ANI)</li>
                                        <li><strong>Valor p:</strong> Significancia estadística de la distancia</li>
                                        <li><strong>Índice de Jaccard:</strong> Similitud entre Q y T</li>
                                    </ul>
                                    <p class="mt-3"><strong>Nota:</strong> Para genomas con ANI > 99.5%, se recomienda usar sketch size ≥ 188</p>
                                </div>
                            </div>

                            <!-- Botones de Acción -->
                            <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                                <button type="button" id="showBindashCommandBtn" 
                                        class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5-6h3" />
                                    </svg>
                                    Mostrar Comando
                                </button>
                                <button type="submit" 
                                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    Ejecutar BinDash
                                </button>
                            </div>
                            
                            <div id="bindashCommandDisplay" class="mt-4 p-4 bg-gray-100 rounded-lg hidden">
                                <h5 class="font-semibold text-gray-800 mb-2">Comando BinDash:</h5>
                                <pre id="bindashCommand" class="text-sm text-gray-800 whitespace-pre-wrap bg-white p-3 rounded border"></pre>
                            </div>
                        </form>
                    </div>


                    <!-- Tabla de Estado de Análisis -->
                    <div class="bg-white p-6 rounded-xl shadow-lg mt-8 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Estado de Análisis
            </h2>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Herramienta
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Archivo
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Estado
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Progreso
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Tiempo
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas se añadirán dinámicamente aquí -->
                    </tbody>
                </table>
                
                <div id="noAnalysisMessage" class="text-center py-8 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="text-lg font-medium">No hay análisis en progreso</p>
                    <p class="text-sm">Los análisis aparecerán aquí cuando se inicien</p>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>
    </main>



    <%- include('partials/footer') %>

    <script>
        // Definir las URLs del backend para cada herramienta
        const BACKEND_URLS = {
            eggnog: 'http://localhost:3002',
            blastn: 'http://localhost:5000',
            bindash: 'http://localhost:4007'
        };

        // Función para obtener la URL correcta según la herramienta
        function getBackendURL(tool) {
            return BACKEND_URLS[tool];
        }

        // Función para extraer el nombre del archivo de una ruta
        function getFilenameFromPath(filePath) {
            return filePath.split('/').pop();
        }

        // Variables globales para manejo de análisis
        let activeAnalyses = [];
        let analysisCounter = 0;

        // Función para añadir análisis a la tabla
        function addAnalysisToTable(analysisData) {
            analysisCounter++;
            const analysisId = `analysis_${analysisCounter}`;
            
            const analysis = {
                id: analysisId,
                tool: analysisData.tool || 'Desconocido',
                file: analysisData.file || 'N/A',
                status: analysisData.status || 'Iniciando',
                progress: analysisData.progress || 0,
                startTime: new Date(),
                ...analysisData
            };
            
            activeAnalyses.push(analysis);
            updateAnalysisTable();
            
            return analysisId;
        }

        // Función para actualizar el estado de un análisis
        function updateAnalysisStatus(analysisId, status, progress = null, resultPath = null) {
            const analysis = activeAnalyses.find(a => a.id === analysisId);
            if (analysis) {
                analysis.status = status;
                if (progress !== null) analysis.progress = progress;
                if (resultPath) analysis.resultPath = resultPath;
                analysis.lastUpdate = new Date();
                updateAnalysisTable();
            }
        }

        // Función para actualizar la tabla visual
        function updateAnalysisTable() {
            const tableBody = document.getElementById('analysisTableBody');
            const noAnalysisMessage = document.getElementById('noAnalysisMessage');
            
            if (activeAnalyses.length === 0) {
                tableBody.innerHTML = '';
                noAnalysisMessage.style.display = 'block';
                return;
            }
            
            noAnalysisMessage.style.display = 'none';
            
            tableBody.innerHTML = activeAnalyses.map(analysis => {
                const elapsed = Math.floor((new Date() - analysis.startTime) / 1000);
                const elapsedTime = formatTime(elapsed);
                
                const statusBadge = getStatusBadge(analysis.status);
                const progressBar = getProgressBar(analysis.progress);
                const actions = getActionButtons(analysis);
                
                return `
                    <tr id="${analysis.id}" class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="text-sm font-medium text-gray-900">${analysis.tool}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${analysis.file}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${progressBar}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${elapsedTime}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            ${actions}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Función para obtener badge de estado
        function getStatusBadge(status) {
            const badges = {
                'Iniciando': 'bg-yellow-100 text-yellow-800',
                'En progreso': 'bg-blue-100 text-blue-800',
                'Completado': 'bg-green-100 text-green-800',
                'Error': 'bg-red-100 text-red-800',
                'Cancelado': 'bg-gray-100 text-gray-800'
            };
            
            const badgeClass = badges[status] || 'bg-gray-100 text-gray-800';
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeClass}">${status}</span>`;
        }

        // Función para obtener barra de progreso
        function getProgressBar(progress) {
            const progressPercent = Math.min(100, Math.max(0, progress));
            return `
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                </div>
                <span class="text-xs text-gray-500 mt-1">${progressPercent}%</span>
            `;
        }

        // Función para obtener botones de acción
        function getActionButtons(analysis) {
            if (analysis.status === 'Completado' && analysis.resultPath) {
                return `
                    <button onclick="viewResults('${analysis.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Ver resultados</button>
                    <button onclick="removeAnalysis('${analysis.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>
                `;
            } else if (analysis.status === 'En progreso') {
                return `<button onclick="cancelAnalysis('${analysis.id}')" class="text-red-600 hover:text-red-900">Cancelar</button>`;
            } else if (analysis.status === 'Error') {
                return `<button onclick="removeAnalysis('${analysis.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>`;
            }
            return '';
        }

        // Función para formatear tiempo
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        // Función para ver resultados
        function viewResults(analysisId) {
            const analysis = activeAnalyses.find(a => a.id === analysisId);
            if (analysis && analysis.resultPath) {
                Swal.fire({
                    title: 'Resultados del análisis',
                    html: `
                        <div class="text-left">
                            <p class="mb-2"><strong>Herramienta:</strong> ${analysis.tool}</p>
                            <p class="mb-2"><strong>Archivo:</strong> ${analysis.file}</p>
                            <p class="mb-2"><strong>Ruta de resultados:</strong></p>
                            <code class="bg-gray-100 px-2 py-1 rounded block">${analysis.resultPath}</code>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Ir a Visualización',
                    cancelButtonText: 'Cerrar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '/visualizer';
                    }
                });
            }
        }

        // Función para eliminar análisis
        function removeAnalysis(analysisId) {
            activeAnalyses = activeAnalyses.filter(a => a.id !== analysisId);
            updateAnalysisTable();
        }

        // Función para cancelar análisis
        function cancelAnalysis(analysisId) {
            updateAnalysisStatus(analysisId, 'Cancelado', 0);
        }

        // Actualizar tabla cada segundo
        setInterval(() => {
            if (activeAnalyses.length > 0) {
                updateAnalysisTable();
            }
        }, 1000);

        // Validar formulario antes de enviar
        document.getElementById('eggNOGForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const proteinFilePath = document.getElementById('proteinFilePath').value;
            const outputName = document.getElementById('outputName').value;
            
            // Validar ruta del archivo
            if (!proteinFilePath.startsWith('/data/')) {
                Swal.fire({
                    title: 'Error en la ruta',
                    text: 'La ruta debe comenzar con /data/',
                    icon: 'error',
                    confirmButtonText: 'Corregir'
                });
                return;
            }
            
            // Validar extensión del archivo
            const validExtensions = ['.faa', '.fasta', '.fa', '.fas', '.pep'];
            const hasValidExtension = validExtensions.some(ext => proteinFilePath.toLowerCase().endsWith(ext));
            
            if (!hasValidExtension) {
                Swal.fire({
                    title: 'Extensión no válida',
                    text: 'El archivo debe tener una de las siguientes extensiones: .faa, .fasta, .fa, .fas, .pep',
                    icon: 'warning',
                    confirmButtonText: 'Corregir'
                });
                return;
            }
            
            // Validar nombre de salida
            if (!/^[a-zA-Z0-9_]+$/.test(outputName)) {
                Swal.fire({
                    title: 'Nombre de salida no válido',
                    text: 'Use solo letras, números y guiones bajos. No use espacios ni caracteres especiales.',
                    icon: 'warning',
                    confirmButtonText: 'Corregir'
                });
                return;
            }
            
            // Continuar con el envío del formulario
            runEggNOGAnalysis();
        });

        // Selección de herramientas para mostrar/ocultar configuraciones
        document.getElementById('toolSelector').addEventListener('change', function(e) {
            const tool = e.target.value;
            document.getElementById('eggNOGConfig').style.display = tool === 'eggnog' ? 'block' : 'none';
            document.getElementById('blastnConfig').style.display = tool === 'blastn' ? 'block' : 'none';
            document.getElementById('bindashConfig').style.display = tool === 'bindash' ? 'block' : 'none';
        });

        // Toggle para Opciones Avanzadas de eggNOG-mapper
        document.getElementById('toggleAdvancedEggNOG').addEventListener('change', function(e) {
            const isChecked = e.target.checked;
            const advancedOptions = document.getElementById('advancedEggNOGOptions');
            advancedOptions.style.display = isChecked ? 'block' : 'none';

            // Si se deshabilita, deshabilitar los campos avanzados
            const inputs = advancedOptions.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.disabled = !isChecked;
                if (!isChecked) {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                }
            });
        });

        // Manejo del cambio de modo en BinDash
        document.getElementById('bindashMode').addEventListener('change', function(e) {
            const mode = e.target.value;
            document.getElementById('sketchConfig').style.display = mode === 'sketch' ? 'block' : 'none';
            document.getElementById('distConfig').style.display = mode === 'dist' ? 'block' : 'none';
            document.getElementById('completeConfig').style.display = mode === 'complete' ? 'block' : 'none';
        });

        // Toggle para Opciones Avanzadas de BinDash
        document.getElementById('toggleAdvancedBindash').addEventListener('change', function(e) {
            const isChecked = e.target.checked;
            const advancedOptions = document.getElementById('advancedBindashOptions');
            advancedOptions.style.display = isChecked ? 'block' : 'none';

            // Si se deshabilita, resetear los campos avanzados
            if (!isChecked) {
                const inputs = advancedOptions.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else if (input.type === 'number') {
                        // Restaurar valores por defecto
                        if (input.id === 'kmerSize') input.value = '16';
                        else if (input.id === 'sketchSize') input.value = '256';
                        else if (input.id === 'bbits') input.value = '1';
                    } else if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0;
                    }
                });
            }
        });





        // ========================================
        // GESTIÓN DE BASE DE DATOS eggNOG
        // ========================================
        
        // Verificar estado de base de datos
        async function checkDatabaseStatus() {
            try {
                const response = await fetch(`${BACKEND_URLS.eggnog}/database/status`);
                const status = await response.json();
                
                const statusText = document.getElementById('dbStatusText');
                const runButton = document.getElementById('runEggNOGBtn');
                
                if (status.isDownloaded) {
                    statusText.textContent = `✅ Disponible (${status.size})`;
                    statusText.className = 'text-sm text-green-700 mt-1';
                    runButton.disabled = false;
                } else {
                    statusText.textContent = '❌ No disponible';
                    statusText.className = 'text-sm text-red-700 mt-1';
                    runButton.disabled = true;
                }
                
                return status;
            } catch (error) {
                console.error('Error verificando base de datos:', error);
                const statusText = document.getElementById('dbStatusText');
                statusText.textContent = '⚠️ Error de conexión';
                statusText.className = 'text-sm text-red-700 mt-1';
                document.getElementById('runEggNOGBtn').disabled = true;
            }
        }
        
        // Event listeners para base de datos
        document.getElementById('checkDbBtn').addEventListener('click', checkDatabaseStatus);
        
        // Verificar estado inicial cuando se muestra eggNOG
        document.getElementById('toolSelector').addEventListener('change', function(e) {
            if (e.target.value === 'eggnog') {
                // Verificar inmediatamente y luego con un pequeño delay para asegurar que los elementos están cargados
                checkDatabaseStatus();
                setTimeout(checkDatabaseStatus, 100);
            }
        });

        // Verificar automáticamente al cargar la página si eggNOG ya está seleccionado
        document.addEventListener('DOMContentLoaded', function() {
            const toolSelector = document.getElementById('toolSelector');
            if (toolSelector && toolSelector.value === 'eggnog') {
                setTimeout(checkDatabaseStatus, 500);
            }
        });
        
        // Manejar selector de taxonomic scope
        document.getElementById('taxScopeSelect').addEventListener('change', function(e) {
            const taxScopeInput = document.getElementById('taxScope');
            if (e.target.value === 'custom') {
                taxScopeInput.style.display = 'block';
                taxScopeInput.value = '';
                taxScopeInput.placeholder = 'Ingrese ID taxonómico personalizado';
            } else {
                taxScopeInput.style.display = 'none';
                taxScopeInput.value = e.target.value;
            }
        });

        // Ejecutar análisis eggNOG-mapper
        async function runEggNOGAnalysis() {
            const form = document.getElementById('eggNOGForm');
            const formData = new FormData(form);
            const data = {};
            
            // Convertir FormData a objeto
            formData.forEach((value, key) => {
                // Convertir checkboxes a booleanos
                if (key === 'translate' || key === 'resume' || key === 'override' || key === 'noFileComments') {
                    data[key] = value === 'on';
                } else {
                    data[key] = value;
                }
            });
            
            // Añadir análisis a la tabla
            const fileName = getFilenameFromPath(data.proteinFilePath);
            const analysisId = addAnalysisToTable({
                tool: 'eggNOG-mapper',
                file: fileName,
                status: 'Iniciando',
                progress: 0
            });
            

            
            try {
                console.log('Intentando conectar a:', `${BACKEND_URLS.eggnog}/run-eggnog`);
                console.log('Datos a enviar:', data);
                
                // Actualizar estado a "En progreso"
                updateAnalysisStatus(analysisId, 'En progreso', 5);
                
                const response = await fetch(`${BACKEND_URLS.eggnog}/run-eggnog`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Error desconocido';
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorData.message || 'Error del servidor';
                        console.error('Error detallado:', errorData);
                    } catch (parseError) {
                        errorMessage = `Error del servidor (${response.status}): ${errorText.substring(0, 200)}`;
                        console.error('Error parsing response:', errorText);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                
                // Actualizar estado a "Completado"
                updateAnalysisStatus(analysisId, 'Completado', 100, result.outputPath);
                
                // Mostrar resultados
                Swal.fire({
                    title: '¡Análisis completado!',
                    html: `
                        <div class="text-left">
                            <h3 class="font-bold text-lg mb-2">Resumen:</h3>
                            <p class="mb-2">ID de trabajo: <code class="bg-gray-100 px-1 py-0.5 rounded">${result.jobId}</code></p>
                            <p class="mb-2">Archivos generados: <code class="bg-gray-100 px-1 py-0.5 rounded">${result.annotationFiles?.length || 0}</code></p>
                            <p class="mb-2">Directorio de resultados: <code class="bg-gray-100 px-1 py-0.5 rounded">${result.outputPath}</code></p>
                            
                            <h3 class="font-bold text-lg mt-4 mb-2">¿Qué desea hacer ahora?</h3>
                            <p>Puede visualizar los resultados en la sección de Visualización o revisar el estado en la tabla de análisis</p>
                        </div>
                    `,
                    icon: 'success',
                    confirmButtonText: 'Ver resultados',
                    showCancelButton: true,
                    cancelButtonText: 'Cerrar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Redirigir a la página de visualización
                        window.location.href = '/visualizer';
                    }
                });
                
            } catch (error) {
                console.error(' Error detallado al ejecutar eggNOG-mapper:', error);
                
                // Actualizar estado a "Error"
                updateAnalysisStatus(analysisId, 'Error', 0);
                
                Swal.fire({
                    title: 'Error al ejecutar eggNOG-mapper',
                    html: `
                        <div class="text-left">
                            <h3 class="font-bold text-lg mb-2">Detalles del error:</h3>
                            <p class="mb-2 text-red-600">${error.message}</p>
                            
                            <h3 class="font-bold text-lg mt-4 mb-2">Posibles soluciones:</h3>
                            <ul class="list-disc pl-5">
                                <li class="mb-1">Verifique que la ruta del archivo sea correcta y comience con <code class="bg-gray-100 px-1 py-0.5 rounded">/data/</code></li>
                                <li class="mb-1">Asegúrese de que el archivo exista y tenga formato FASTA válido</li>
                                <li class="mb-1">Compruebe que la base de datos eggNOG esté descargada</li>
                                <li class="mb-1">Verifique que el servidor eggNOG-mapper esté en ejecución</li>
                            </ul>
                        </div>
                    `,
                    icon: 'error',
                    confirmButtonText: 'Entendido'
                });
                
            } finally {
                // La tabla ya maneja el estado del análisis
            }
        }

        // Manejo de la ejecución de BlastN
        document.getElementById('blastnForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const databaseType = form.databaseType.value;

            try {
                // Mostrar el análisis en la tabla y comenzar animación
                const uniqueId = addAnalysisToTable({
                    type: 'BlastN',
                    status: 'En progreso',
                    progress: '0%',
                    actions: ''
                });

                // Preparar los datos
                const data = {
                    queryFilePath: form.queryFilePath.value.trim(),
                    database: databaseType === 'custom' ? 
                        form.customDatabase.value.trim() : 
                        form.predefinedDatabase.value.trim(),
                    databaseType: databaseType,
                    evalue_blastn: form.evalue_blastn.value.trim(),
                    wordSize: form.wordSize.value.trim(),
                    numThreads: form.numThreads.value.trim(),
                    outfmt: form.outfmt.value.trim(),
                    out_blastn: form.out_blastn.value.trim(),
                    remote_blastn: form.remote_blastn.checked
                };

                console.log('Enviando datos al servidor:', data);

                // Validaciones
                if (!data.queryFilePath || !data.out_blastn) {
                    throw new Error('Las rutas de entrada y salida son requeridas.');
                }

                if (data.databaseType === 'custom' && !data.database) {
                    throw new Error('Debe especificar la ruta de la base de datos personalizada.');
                }

                console.log('Intentando conectar a:', `${BACKEND_URLS.blastn}/run-blastn`);
                
                const response = await fetch(`${BACKEND_URLS.blastn}/run-blastn`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data),
                    credentials: 'include'
                }).catch(error => {
                    console.error('Error en fetch:', error);
                    throw new Error(`Error de conexión: ${error.message}`);
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Error del servidor: ${response.status}`);
                }

                const result = await response.json();
                console.log('Respuesta del servidor:', result);
                
                // Actualizar UI con éxito
                alert('BlastN ejecutado exitosamente');

            } catch (error) {
                console.error('Error detallado al ejecutar BlastN:', error);
                alert(`Error: ${error.message}`);
            }
        });

        // Manejo de la selección de tipo de base de datos
        document.getElementById('databaseType').addEventListener('change', function(e) {
            const isCustom = e.target.value === 'custom';
            document.getElementById('predefinedDatabase').style.display = isCustom ? 'none' : 'block';
            document.getElementById('customDatabase').style.display = isCustom ? 'block' : 'none';
        });

        // Botones para mostrar comandos
        document.getElementById('showEggNOGCommandBtn').addEventListener('click', function() {
            const form = document.getElementById('eggNOGForm');
            const data = {
                proteinFilePath: form.proteinFilePath.value.trim(),
                outputName: form.outputName.value.trim(),
                taxScope: form.taxScope.value.trim(),
                cpu: form.cpu.value.trim(),
                mode: form.mode.value.trim(),
                evalue: form.evalue.value.trim(),
                pident: form.pident.value.trim(),
                noFileComments: form.noFileComments.checked,
                resume: form.resume.checked,
                override: form.override.checked,
                itype: form.itype.value.trim(),
                translate: form.translate.checked,
                genepred: form.genepred.value.trim()
            };

            const command = `python3 emapper.py \\
-i "${data.proteinFilePath}" \\
-o "${data.outputName}" \\
${data.taxScope ? `--tax_scope ${data.taxScope}` : ''} \\
${data.cpu ? `--cpu ${data.cpu}` : ''} \\
${data.itype ? `--itype ${data.itype}` : ''} \\
${data.translate ? '--translate' : ''} \\
${data.genepred ? `--genepred ${data.genepred}` : ''} \\
${data.mode ? `-m ${data.mode}` : ''} \\
${data.evalue ? `--evalue ${data.evalue}` : ''} \\
${data.pident ? `--pident ${data.pident}` : ''} \\
${data.noFileComments ? '--no_file_comments' : ''} \\
${data.resume ? '--resume' : ''} \\
${data.override ? '--override' : ''}`;

            document.getElementById('eggNOGCommand').textContent = command;
            document.getElementById('eggNOGCommandDisplay').classList.toggle('hidden');
        });

        document.getElementById('showBlastNCommandBtn').addEventListener('click', function() {
            const form = document.getElementById('blastnForm');
            const databaseType = form.databaseType.value;
            
            const data = {
                queryFilePath: form.queryFilePath.value.trim(),
                database: databaseType === 'custom' ? 
                    form.customDatabase.value.trim() : 
                    form.predefinedDatabase.value.trim(),
                evalue_blastn: form.evalue_blastn.value.trim(),
                wordSize: form.wordSize.value.trim(),
                numThreads: form.numThreads.value.trim(),
                outfmt: form.outfmt.value.trim(),
                out_blastn: form.out_blastn.value.trim(),
                remote_blastn: form.remote_blastn.checked
            };

            const command = `blastn \\
-query "${data.queryFilePath}" \\
-db "${data.database}" \\
-out "${data.out_blastn}" \\
-evalue ${data.evalue_blastn} \\
-word_size ${data.wordSize} \\
-num_threads ${data.numThreads} \\
-outfmt ${data.outfmt} \\
${data.remote_blastn ? '-remote' : ''}`;

            document.getElementById('blastnCommand').textContent = command;
            document.getElementById('blastnCommandDisplay').classList.toggle('hidden');
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Configurar el explorador para usar la categoría 'results' y subcategoría 'analysis' por defecto
            if (window.FileExplorer) {
                window.FileExplorer.navigateTo('results', 'analysis');
            }
        });

        // Función para monitorear progreso de BinDash en tiempo real
        function monitorBindashProgress(uniqueId) {
            const eventSource = new EventSource(`${BACKEND_URLS.bindash}/bindash-progress`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Actualizar la barra de progreso
                const progressBar = document.getElementById(`progressBar-${uniqueId}`);
                if (progressBar) {
                    progressBar.style.width = `${data.progress}%`;
                }
                
                // Actualizar el texto de progreso
                const progressText = document.getElementById(`progressText-${uniqueId}`);
                if (progressText) {
                    progressText.textContent = `${data.progress}%`;
                }
                
                // Actualizar el estado según el progreso
                const tableRow = document.querySelector(`tr[data-id="${uniqueId}"]`);
                if (tableRow) {
                    const statusCell = tableRow.querySelector('td:nth-child(2) span');
                    if (data.progress < 15) {
                        statusCell.textContent = 'Iniciando';
                        statusCell.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800';
                    } else if (data.progress < 35) {
                        statusCell.textContent = 'Preparando archivos';
                        statusCell.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800';
                    } else if (data.progress < 75) {
                        statusCell.textContent = 'Creando sketch';
                        statusCell.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800';
                    } else if (data.progress < 100) {
                        statusCell.textContent = 'Calculando distancias';
                        statusCell.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800';
                    } else {
                        statusCell.textContent = 'Completado';
                        statusCell.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800';
                        eventSource.close(); // Cerrar conexión cuando termine
                    }
                }
                
                console.log(`BinDash progreso: ${data.progress}% - ${data.message}`);
            };
            
            eventSource.onerror = function(event) {
                console.error('Error en EventSource de BinDash:', event);
                eventSource.close();
            };
            
            // Guardar referencia para poder cerrarla después
            window.bindashProgressSource = eventSource;
        }

        // Manejo de la ejecución de BinDash
        document.getElementById('bindashForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const mode = form.bindashMode.value;

            if (!mode) {
                alert('Por favor seleccione un modo de operación');
                return;
            }

            try {
                // Mostrar el análisis en la tabla
                const uniqueId = addAnalysisToTable({
                    type: 'BinDash',
                    status: 'En progreso',
                    progress: '0%',
                    actions: ''
                });

                // Iniciar monitoreo de progreso en tiempo real
                monitorBindashProgress(uniqueId);

                // Preparar los datos según el modo seleccionado
                let data = {
                    mode: mode,
                    // Parámetros avanzados (si están habilitados)
                    kmerSize: form.kmerSize.value || '21',
                    sketchSize: form.sketchSize.value || '32',
                    bbits: form.bbits.value || '14',
                    nthreads: form.nthreads ? form.nthreads.value || '1' : '1'
                };

                // Agregar parámetros específicos según el modo
                if (mode === 'sketch') {
                    data.sketchInput = form.sketchInput.value.trim();
                    data.sketchOutput = form.sketchOutput.value.trim();
                    data.useListFile = form.useListFile.checked;
                    
                    if (!data.sketchInput || !data.sketchOutput) {
                        throw new Error('Los campos de entrada y salida son requeridos para el modo sketch');
                    }
                } else if (mode === 'dist') {
                    data.querySketch = form.querySketch.value.trim();
                    data.targetSketch = form.targetSketch.value.trim();
                    data.distOutput = form.distOutput.value.trim();
                    
                    if (!data.querySketch) {
                        throw new Error('El sketch de consulta es requerido para el modo dist');
                    }
                } else if (mode === 'complete') {
                    data.genomesDir = form.genomesDir.value.trim();
                    data.filePattern = form.filePattern.value.trim() || '*.fasta';
                    data.outputPrefix = form.outputPrefix.value.trim();
                    
                    if (!data.genomesDir || !data.outputPrefix) {
                        throw new Error('El directorio de genomas y prefijo de salida son requeridos');
                    }
                }

                console.log('Enviando datos a BinDash:', data);

                const response = await fetch(`${BACKEND_URLS.bindash}/run-bindash`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data),
                    credentials: 'include'
                }).catch(error => {
                    console.error('Error en fetch:', error);
                    throw new Error(`Error de conexión: ${error.message}`);
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Error del servidor: ${response.status}`);
                }

                const result = await response.json();
                console.log('Respuesta del servidor BinDash:', result);
                
                // Actualizar UI con éxito
                alert('BinDash ejecutado exitosamente');

            } catch (error) {
                console.error('Error detallado al ejecutar BinDash:', error);
                
                let errorMessage = 'Error al ejecutar BinDash: ';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'No se pudo conectar al servidor. Por favor, verifica que el servidor de BinDash (puerto 4007) esté funcionando.';
                } else {
                    errorMessage += error.message;
                }
                alert(errorMessage);
            }
        });

        // Botón para mostrar comando de BinDash
        document.getElementById('showBindashCommandBtn').addEventListener('click', function() {
            const form = document.getElementById('bindashForm');
            const mode = form.bindashMode.value;
            
            if (!mode) {
                alert('Por favor seleccione un modo de operación primero');
                return;
            }

            let command = '';
            const advancedEnabled = document.getElementById('toggleAdvancedBindash').checked;
            
            // Parámetros avanzados comunes
            let advancedParams = '';
            if (advancedEnabled) {
                const kmerSize = form.kmerSize.value || '16';
                const sketchSize = form.sketchSize.value || '256';
                const bbits = form.bbits.value || '1';
                const densification = form.densification.value || '1';
                const evolutionModel = form.evolutionModel.value || 'poisson';
                
                advancedParams = ` \\
--kmersize ${kmerSize} \\
--sketchsize64 ${sketchSize} \\
--bbits ${bbits} \\
--dens ${densification} \\
--model ${evolutionModel}`;
                
                if (form.canonical.checked) advancedParams += ' \\\n--canonical';
                if (form.protein.checked) advancedParams += ' \\\n--protein';
                if (form.verbose.checked) advancedParams += ' \\\n--verbose';
            }

            // Generar comando según el modo
            if (mode === 'sketch') {
                const input = form.sketchInput.value.trim();
                const output = form.sketchOutput.value.trim();
                const useList = form.useListFile.checked;
                
                command = `bindash sketch \\
${useList ? `--listfname="${input}"` : `"${input}"`} \\
--outfname="${output}"${advancedParams}`;
                
            } else if (mode === 'dist') {
                const query = form.querySketch.value.trim();
                const target = form.targetSketch.value.trim();
                const output = form.distOutput.value.trim();
                
                command = `bindash dist \\
"${query}"`;
                if (target) command += ` \\\n"${target}"`;
                if (output) command += ` \\\n--outfname="${output}"`;
                command += advancedParams;
                
            } else if (mode === 'complete') {
                const genomesDir = form.genomesDir.value.trim();
                const pattern = form.filePattern.value.trim() || '*.fasta';
                const prefix = form.outputPrefix.value.trim();
                
                command = `# Paso 1: Crear lista de genomas
ls ${genomesDir}${pattern} > ${prefix}_genomes.txt

# Paso 2: Crear sketch
bindash sketch \\
--listfname="${prefix}_genomes.txt" \\
--outfname="${prefix}.sketch"${advancedParams}

# Paso 3: Calcular distancias (all-vs-all)
bindash dist \\
"${prefix}.sketch" \\
--outfname="${prefix}_distances.txt"${advancedParams}`;
            }

            document.getElementById('bindashCommand').textContent = command;
            document.getElementById('bindashCommandDisplay').classList.toggle('hidden');
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Configurar el explorador para usar la categoría 'results' y subcategoría 'analysis' por defecto
            if (window.FileExplorer) {
                window.FileExplorer.navigateTo('results', 'analysis');
            }
        });

        // Listar archivos disponibles
        document.getElementById('listFilesBtn').addEventListener('click', async function() {
            try {
                // Simular listado de archivos (en un caso real, esto sería una llamada al backend)
                const availableFiles = [
                    '/data/genomes/GCA_000170995.2.faa',
                    '/data/genomes/GCA_000171015.2.faa',
                    '/data/genomes/GCA_000513815.1.faa',
                    '/data/genomes/GCA_000988865.1.faa',
                    '/data/genomes/GCA_001050175.1.faa',
                    '/data/genomes/GCA_001481775.2.faa',
                    '/data/genomes/GCA_002022785.1.faa'
                ];
                
                const fileOptions = availableFiles.map(file => {
                    const fileName = file.split('/').pop();
                    return `<div class="flex justify-between items-center p-2 hover:bg-gray-100 rounded cursor-pointer" onclick="selectFile('${file}')">
                        <span class="text-sm">${fileName}</span>
                        <span class="text-xs text-gray-500">${file}</span>
                    </div>`;
                }).join('');
                
                Swal.fire({
                    title: 'Archivos disponibles en /data/genomes/',
                    html: `
                        <div class="text-left max-h-96 overflow-y-auto">
                            <p class="mb-4 text-sm text-gray-600">Haga clic en un archivo para seleccionarlo:</p>
                            ${fileOptions}
                        </div>
                    `,
                    width: '600px',
                    showConfirmButton: false,
                    showCancelButton: true,
                    cancelButtonText: 'Cerrar'
                });
                
            } catch (error) {
                console.error('Error listando archivos:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudieron listar los archivos disponibles',
                    icon: 'error'
                });
            }
        });
        
        // Función para seleccionar archivo
        window.selectFile = function(filePath) {
            document.getElementById('proteinFilePath').value = filePath;
            Swal.close();
            
            // Mostrar confirmación
            Swal.fire({
                title: 'Archivo seleccionado',
                text: `Se ha seleccionado: ${filePath}`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        };

        // Ayuda para formatos de ruta
        document.getElementById('helpProteinPath').addEventListener('click', function() {
            Swal.fire({
                title: 'Formato de Rutas para eggNOG-mapper',
                html: `
                    <div class="text-left">
                        <h3 class="font-bold text-lg mb-2">Estructura de rutas recomendada:</h3>
                        <ul class="list-disc pl-5 mb-4">
                            <li class="mb-1"><code class="bg-gray-100 px-1 py-0.5 rounded">/data/genomes/mi_archivo.faa</code></li>
                            <li class="mb-1"><code class="bg-gray-100 px-1 py-0.5 rounded">/data/proteinas/mi_archivo.fasta</code></li>
                        </ul>
                        
                        <h3 class="font-bold text-lg mb-2">¡Importante!</h3>
                        <p class="mb-2">Debe usar rutas absolutas que comiencen con <code class="bg-gray-100 px-1 py-0.5 rounded">/data/</code></p>
                        <p class="mb-2">No use rutas relativas como <code class="bg-red-100 px-1 py-0.5 rounded">./data/...</code></p>
                        
                        <h3 class="font-bold text-lg mb-2">Formatos aceptados:</h3>
                        <ul class="list-disc pl-5">
                            <li>.faa (preferido)</li>
                            <li>.fasta</li>
                            <li>.fa</li>
                            <li>.fas</li>
                            <li>.pep</li>
                        </ul>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Entendido'
            });
        });

        document.getElementById('helpOutputName').addEventListener('click', function() {
            Swal.fire({
                title: 'Nombre de salida para eggNOG-mapper',
                html: `
                    <div class="text-left">
                        <h3 class="font-bold text-lg mb-2">Recomendaciones:</h3>
                        <ul class="list-disc pl-5 mb-4">
                            <li class="mb-1">Use solo letras, números y guiones bajos</li>
                            <li class="mb-1">No incluya extensión (.faa, .txt, etc.)</li>
                            <li class="mb-1">No incluya espacios ni caracteres especiales</li>
                        </ul>
                        
                        <h3 class="font-bold text-lg mb-2">Ejemplos:</h3>
                        <ul class="list-disc pl-5">
                            <li><code class="bg-gray-100 px-1 py-0.5 rounded">resultado_genoma1</code></li>
                            <li><code class="bg-gray-100 px-1 py-0.5 rounded">anotacion_proteinas_2023</code></li>
                            <li><code class="bg-gray-100 px-1 py-0.5 rounded">eggnog_resultado</code></li>
                        </ul>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Entendido'
            });
        });
    </script>
</body>
